### Setup
{% highlight bash %}
$ mkdir scraper && cd scraper
$ virtualenv venv
$ source venv/bin/activate
$ pip install mechanize
$ pip install beautifulsoup4
{% endhighlight %}

{% highlight python %}
import mechanize
br = mechanize.Browser()
{% endhighlight %}

### Setting the user-agent

{% highlight python %}
br.addheaders = [('User-agent',
                  'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_6_8) AppleWebKit/535.7 (KHTML, like Gecko) Chrome/16.0.912.63 Safari/535.7')]
{% endhighlight %}

### Handling robots

{% highlight python %}
br.set_handle_robots(False)
{% endhighlight %}

### Form selection

Select a form using `select_form` with the name of the form as the argument:

{% highlight python %}
br.select_form('searchForm')
{% endhighlight %}

### Form selection using a predicate function

If the form does not have a name attribute, you can use a predicate function to select the form based off
of one of its other attributes. 

For instance, the following form has no `name` attribute:

{% highlight html %}
<form method="post" action="/en/search/" id="form1">
{% endhighlight %}

We can select this form by filtering based on its `id`.

{% highlight python %}
def select_form(form):
  return form.attrs.get('id', None) == 'form1'

br.select_form(predicate=select_form)
br.submit()
{% endhighlight %}

Or we can select against the form's `action` instead:

{% highlight python %}
def select_form(form):
  return form.attrs.get('action', None) == '/en/search/'

br.select_form(predicate=select_form)
br.submit()
{% endhighlight %}

### Selecting links using a predicate function

You can select links in a similar fashion. The following code
selects and follows an iframe using a predicate function to identify
it based on its `tag` and `id`:

{% highlight python %}
def select_iframe(iframe):
  return dict(iframe.attrs).get('id', None) == 'main'

br.follow_link(br.find_link(tag='iframe', predicate=select_iframe))
{% endhighlight %}

### Control selection using a predicate function

Use predicate functions in conjunction with regular-expressions to
select controls within a form that match a specific pattern:

{% highlight python %}
import re

# raytheon.py
def select_control(control):
  r = re.compile(r'ctl\d+_HiddenField')
  return bool(re.match(r, control.name))

ctl = br.form.find_control(predicate=select_control)
ctl.value = 'someval'
{% endhighlight %}

### Submitting a form

Once of you have all of the values for a form set, submit it by
calling `submit`:

{% highlight python %}
br.submit()
{% endhighlight %}

### Form submission when multiple submit buttons present

Sometimes you can't just call `submit` because there's more than one submit button 
and you want mechanize to choose a specific one. A common scenario is when one of 
these buttons is for 'Search' and the other is for 'Reset'ing the form:

{% highlight html %}
<form name="searchForm" method="post" action="search.do">
  ...
  <input type="image" name="reset" src="Reset.gif" alt="Reset Form">
  <input type="image" name="input" src="Search.gif" id="searchButton" alt="Search">
  ...
</form>
{% endhighlight %}

In this case, pass the id of the desired control when calling `submit`:

{% highlight python %}
br.select_form('searchForm')
br.submit(id='searchButton')
{% endhighlight %}

or specify the name:

{% highlight python %}
br.select_form('searchForm')
br.submit(name='input')
{% endhighlight %}

### Handling 'ParseError: OPTION outside of SELECT' by prettyfing form

Sometimes you will attempt to select a form, but it will fail with the following error:

{% highlight python %}
mechanize._form.ParseError: OPTION outside of SELECT
{% endhighlight %}

An easy way to fix the situation is by running the HTML for the page through
BeautifulSoup before attempting to select the form with mechanize:

{% highlight python %}
import mechanize
from bs4 import BeautifulSoup

br = mechanize.Browser()
br.open(url)

soup = BeautifulSoup(br.response().read())
html = str(soup)
resp = mechanize.make_response(html, [("Content-Type", "text/html")],
                               br.geturl(), 200, "OK")
br.set_response(resp)
br.select_form('aspnetForm')
br.submit()
{% endhighlight %}

### Setting htmlresponse with mechanize

### Adding controls

Some forms have their controls dynamically generated by javascript on the page. You
will often encounter this with the asp.net built-in method `__doPostBack(eventTarget, eventArgument)`.

{% highlight javascript %}
var theForm = document.forms['form1'];
if (!theForm) {
    theForm = document.form1;
}

function __doPostBack(eventTarget, eventArgument) {
    if (!theForm.onsubmit || (theForm.onsubmit() != false)) {
        theForm.__EVENTTARGET.value = eventTarget;
        theForm.__EVENTARGUMENT.value = eventArgument;
        theForm.submit();
    }
}
{% endhighlight %}

Later you will see this called from within a link. 

{% highlight javascript %}
<a href="javascript:__doPostBack('maincontent_0$jobsearchresults_0$next_page','')">
  &nbsp; Next
</a>
{% endhighlight %}

You will need to create controls for __EVENTTARGET, __EVENTARGUMENT, and __LASTFOCUS in order to 
get the form submission to work:

{% highlight python %}

br.form.new_control('hidden', '__EVENTTARGET',   {'value': 'maincontent_0$jobsearchresults_0$next_page'})
br.form.new_control('hidden', '__EVENTARGUMENT', {'value': ''})
br.form.new_control('hidden', '__LASTFOCUS',     {'value': ''})
br.form.fixup()
{% endhighlight %}

### Removing controls to make form submissions work

{% highlight python %}
# raytheon.py
for control in br.form.controls[:]:
  if control.type in ['submit', 'image', 'checkbox']:
    br.form.controls.remove(control)
{% endhighlight %}

### Getting a list of items

Sometimes we want to get all of the results for every item in a select-dropdown.
To do so, get a list of all the items in the select control before hand and then
submit them one a time to get the results for each item:

{% highlight html %}
<select name="more_cheeses">
<option value="1">Swiss</option>
<option value="2">Cheddar</option>
<option value="3">Provolone</option>
</select>       
{% endhighlight %}

{% highlight python %}
br.select_form(predicate=select_form)
items = br.form.find_control('more_cheeses').get_items()

for item in self.items:
  label = ' '.join([label.text for label in item.get_labels()])
  print 'Getting results for ', label

  br.open(self.url)
  br.select_form(predicate=select_form)
  br.form['r_course_yr'] = [ item.name ]
  br.submit()
{% endhighlight %}

### Adding items dynamically

{% highlight python %}
# chevron.py
br.form.set_value_by_label(['North America'], name='searchAuxRegionID')
item = Item(br.form.find_control(name='searchAuxCountryID'),
           {'contents': '3', 'value': '3', 'label': 3})
br.form['searchAuxCountryID'] = ['3']
{% endhighlight %}
